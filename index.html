<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Redirecting...</title>

        <!-- 
          IMPORTANT: Add these meta tags to prevent browser caching.
          This ensures the script runs fresh on every visit, fixing the "second click" bug.
        -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
    </head>
    <body>
        <p>Redirecting to your application...</p>
        <p>This tab will close automatically.</p>
    </body>
    <script>
        // Flag to prevent closing if the redirect fails
        let redirectInitiated = false;

        // When the window loses focus (e.g., when the "Open App?" dialog appears,
        // or the app itself opens), we assume the redirect was successful and close the tab.
        window.onblur = function() {
            if (redirectInitiated) {
                // A small delay can help ensure the handoff to the OS is complete.
                // 200ms is usually enough without being noticeable.
                setTimeout(function() {
                    window.close();
                }, 200);
            }
        };

        // Check if there is a query string (anything after '?')
        if (window.location.search) {
            try {
                // The query string includes the leading '?'. We slice it off (from the 1st character to the end).
                // Then, we decode it to handle special characters like ':' and '/' that get URL-encoded.
                const targetURI = decodeURIComponent(window.location.search.slice(1));

                // A simple validation to ensure we're not redirecting to something obviously wrong.
                // This checks if the decoded string contains '://', which all URIs will have.
                if (targetURI.includes("://")) {
                    // Redirect to the decoded custom URI.
                    window.location.href = targetURI;
                } else {
                    // If the query is invalid, you could show an error or just do nothing.
                    console.error("Invalid URI in query string:", targetURI);
                    document.body.innerText = "Error: Invalid URI provided in the link.";
                }

            } catch (e) {
                // This catches potential errors from decodeURIComponent if the URI is malformed.
                console.error("Failed to decode URI:", e);
                document.body.innerText = "Error: Could not process the provided link.";
            }
        } else {
            // If there's no query string, redirect to the project's GitHub page.
            // The <meta http-equiv="refresh"> tag above already attempts this,
            // but this script is a reliable fallback.
            window.location.href = "https://github.com/yxdongxjtu/notion2ob";
        }
    </script>
</html>
